<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Simple styling only -->
    <style>
        body { 
            background-color: #f8f9fa; 
        }
        .main-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <span class="navbar-brand">Admin Dashboard - {{ user.Full_Name }}</span>
                <div class="navbar-nav ms-auto">
                    <a href="#users" class="nav-link text-white">Users</a>
                    <a href="#search" class="nav-link text-white">Search</a>
                    <a href="#summary" class="nav-link text-white">Summary</a>
                    <a href="{{ url_for('summary_charts') }}" class="nav-link text-white">Charts</a>
                    <a href="{{ url_for('logout') }}" class="nav-link text-white">Logout</a>
                </div>
            </div>
        </nav>

        <!-- Main Content Container -->
        <div class="main-content">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} mt-2">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- Parking Lots Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Parking Lots</h5>
                    <a href="{{ url_for('add_lot') }}" class="btn btn-primary btn-sm">+ Add Lot</a>
                </div>
                <div class="card-body">
                    {% if lots %}
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Location</th>
                                <th>Address</th>
                                <th>Price/Hour</th>
                                <th>Occupied/Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lot in lots %}
                            {% set occupied_count = lot.available_spots|selectattr('Current_Status', 'equalto', 'O')|list|length %}
                            <tr>
                                <td>{{ lot.id }}</td>
                                <td>{{ lot.Location_Name }}</td>
                                <td>{{ lot.Address_name }}</td>
                                <td>â‚¹{{ lot.PRICE }}</td>
                                <td>{{ occupied_count }}/{{ lot.Maximum_Number_Spots }}</td>
                                <td>
                                    <a href="{{ url_for('edit_lot', lot_id=lot.id) }}" class="btn btn-warning btn-sm">Edit</a>
                                    <form action="{{ url_for('delete_lot', lot_id=lot.id) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center">No parking lots created yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Parking Spots Visual -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Parking Spots Overview</h5>
                </div>
                <div class="card-body">
                    {% for lot in lots %}
                    <div class="mb-3">
                        <strong>{{ lot.Location_Name }}</strong>
                        <div>
                            {% for spot in lot.available_spots %}
                                {% if spot.Current_Status == 'O' %}
                                    <span class="badge bg-danger me-1 mb-1">{{ spot.Spot_Number }}</span>
                                {% else %}
                                    <span class="badge bg-success me-1 mb-1">{{ spot.Spot_Number }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    <small class="text-muted">Red = Occupied, Green = Available</small>
                </div>
            </div>

            <!-- Search Section (FIXED - REMOVED SPOT ID) -->
            <div class="card mb-4" id="search">
                <div class="card-header">
                    <h5>Search</h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="row g-2">
                        <div class="col-md-3">
                            <select name="search_type" class="form-select">
                                <option value="location">By Location</option>
                                <option value="user">By User</option>
                                <!-- REMOVED: <option value="spot">By Spot ID</option> -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" name="search_query" class="form-control" 
                                   placeholder="Enter search term..." value="{{ search_query or '' }}">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">Search</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card mb-4" id="users">
                <div class="card-header">
                    <h5>Registered Users ({{ users|length }})</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Full Name</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Role</th>
                                <th>Bookings</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.User_id }}</td>
                                <td>{{ user.Email_Address }}</td>
                                <td>{{ user.Full_Name }}</td>
                                <td>{{ user.Phone_Number }}</td>
                                <td>{{ user.Address }}, {{ user.Pin_Code }}</td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if user.Role == 'admin' else 'primary' }}">
                                        {{ user.Role.title() }}
                                    </span>
                                </td>
                                <td>{{ user.user_reservations|length }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Parking History -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Recent Parking History</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Location</th>
                                <th>Vehicle No</th>
                                <th>Entry Time</th>
                                <th>Exit Time</th>
                                <th>Duration</th>
                                <th>Cost</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations[-10:] %}
                            <tr>
                                <td>{{ reservation.Reservation_Id }}</td>
                                <td>{{ reservation.customer_booking.Full_Name }}</td>
                                <td>{{ reservation.allocated_spot.belong_to_lot.Location_Name }}</td>
                                <td>{{ reservation.Vehicle_Number }}</td>
                                <td>
                                    {% if reservation.Entry_Time %}
                                        {{ reservation.Entry_Time.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reservation.Exit_Time %}
                                        {{ reservation.Exit_Time.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reservation.Entry_Time and reservation.Exit_Time %}
                                        {% set duration = (reservation.Exit_Time - reservation.Entry_Time).total_seconds() / 3600 %}
                                        {{ "%.1f"|format(duration) }} hrs
                                    {% else %}
                                        Ongoing
                                    {% endif %}
                                </td>
                                <td>â‚¹{{ reservation.Total_Cost or 0 }}</td>
                                <td>
                                    {% if reservation.Exit_Time %}
                                        <span class="badge bg-success">Completed</span>
                                    {% else %}
                                        <span class="badge bg-warning">Active</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Summary Section -->
            <div class="card mb-4" id="summary">
                <div class="card-header">
                    <h5>Dashboard Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <div class="border p-3 rounded">
                                <h4 class="text-primary">{{ users|length }}</h4>
                                <small>Total Users</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border p-3 rounded">
                                <h4 class="text-success">{{ lots|length }}</h4>
                                <small>Parking Lots</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border p-3 rounded">
                                <h4 class="text-info">{{ spots|length }}</h4>
                                <small>Total Spots</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border p-3 rounded">
                                <h4 class="text-warning">{{ spots|selectattr('Current_Status', 'equalto', 'A')|list|length }}</h4>
                                <small>Available</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border p-3 rounded">
                                <h4 class="text-danger">{{ spots|selectattr('Current_Status', 'equalto', 'O')|list|length }}</h4>
                                <small>Occupied</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border p-3 rounded">
                                <h4 class="text-dark">â‚¹{{ total_revenue }}</h4>
                                <small>Total Revenue</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
